[tools]
ruby = "3.4.8"
lefthook = "latest"

[tasks.default]
depends = ["dev"]

[tasks.all]
depends = ["build", "up"]

[tasks.build]
run = "docker compose build"

[tasks.bash]
run = "RAILS_ENV=test docker compose run --rm app bash"

[tasks.clean]
run = """
docker compose down --remove-orphans
docker compose rm
docker image prune
docker volume prune
"""

[tasks.cleanforce]
run = """
docker compose down -v --remove-orphans
docker volume rm phishin_pg_data phishin_redis_data 2>/dev/null || true
"""

[tasks.dev]
depends = ["services"]
run = "overmind start -f Procfile.dev -F overmind-local.tmux.conf"

[tasks.services]
run = "docker compose up -d pg redis"

[tasks.spec]
alias = "test"
depends = ["services"]
run = "bundle exec rspec $@"

[tasks.lint]
run = "bundle exec rubocop $@"

[tasks.check]
alias = "ci"
depends = ["lint", "spec"]

[tasks.start]
depends = ["services"]
run = "docker compose up -d"

[tasks.stop]
run = "docker compose stop"

[tasks.up]
depends = ["services"]
run = "docker compose up"

[tasks.restart]
run = """
docker compose stop
docker compose up -d
"""

