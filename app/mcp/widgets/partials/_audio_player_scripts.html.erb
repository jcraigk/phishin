let gaplessPlayer = null;
let allTracks = [];
let currentTrackIndex = -1;
let isPlaying = false;
let isLoading = false;
let showMetadata = null;

function hasAnyAudio(tracks) {
  return tracks && tracks.some(t => t.mp3_url);
}

function getTracksWithAudio() {
  return allTracks.filter(t => t.mp3_url);
}

function showPlayer() {
  const player = document.getElementById('audio-player');
  if (player) {
    player.classList.add('visible');
  }
  const headerPlayBtn = document.getElementById('header-play-btn');
  if (headerPlayBtn) {
    headerPlayBtn.classList.add('fade-out');
  }
  const card = document.querySelector('.card');
  if (card) {
    card.classList.add('player-visible');
  }
  const coverArtContainer = document.querySelector('.cover-art-container');
  if (coverArtContainer) {
    coverArtContainer.classList.add('clickable');
  }
}

function hidePlayer() {
  if (gaplessPlayer) {
    gaplessPlayer.stop();
  }
  
  currentTrackIndex = -1;
  isPlaying = false;
  
  const player = document.getElementById('audio-player');
  if (player) player.classList.remove('visible');
  
  const headerPlayBtn = document.getElementById('header-play-btn');
  if (headerPlayBtn) headerPlayBtn.classList.remove('fade-out');
  
  const card = document.querySelector('.card');
  if (card) {
    card.classList.remove('player-visible');
    card.classList.remove('audio-playing');
  }
  
  const coverArtContainer = document.querySelector('.cover-art-container');
  if (coverArtContainer) coverArtContainer.classList.remove('clickable');
  
  document.querySelectorAll('.track').forEach(el => el.classList.remove('active-item'));
  
  updatePlayPauseIcon();
}

function initAudioPlayer(options = {}) {
  if (!hasAnyAudio(allTracks)) return;

  if (options.showMetadata) {
    showMetadata = options.showMetadata;
  }

  const tracksWithAudio = getTracksWithAudio();
  if (tracksWithAudio.length === 0) return;

  const trackUrls = tracksWithAudio.map(track => track.mp3_url);
  const iosDevice = isIOSDevice();

  gaplessPlayer = new Gapless5({
    tracks: trackUrls,
    loop: false,
    singleMode: false,
    useWebAudio: !iosDevice,
    useHTML5Audio: true,
    loadLimit: iosDevice ? 2 : 1,
    volume: 1.0
  });

  gaplessPlayer.ontimeupdate = (currentTimeMs, trackIndex) => {
    const currentTime = currentTimeMs / 1000;
    const track = tracksWithAudio[trackIndex];
    if (!track) return;

    const duration = track.duration_ms ? track.duration_ms / 1000 : 0;
    if (duration <= 0) return;

    const progress = (currentTime / duration) * 100;

    const progressOverlay = document.getElementById('progress-overlay');
    if (progressOverlay) {
      progressOverlay.style.background = `linear-gradient(to right, var(--progress-color, #b0b0b0) ${progress}%, rgba(255,255,255,0) ${progress}%)`;
    }

    const elapsedEl = document.getElementById('elapsed-time');
    const remainingEl = document.getElementById('remaining-time');
    if (elapsedEl) elapsedEl.textContent = formatTime(currentTime);
    if (remainingEl) remainingEl.textContent = `-${formatTime(duration - currentTime)}`;

    const scrubForwardBtn = document.getElementById('scrub-forward-btn');
    if (scrubForwardBtn) scrubForwardBtn.disabled = currentTime >= duration - 10;
  };

  gaplessPlayer.onloadstart = () => {
    showLoadingSpinner(true);
  };

  gaplessPlayer.onload = () => {
    showLoadingSpinner(false);
  };

  gaplessPlayer.onplay = () => {
    isPlaying = true;
    document.querySelector('.card')?.classList.add('audio-playing');
    updatePlayPauseIcon();
    updateMediaSessionPlaybackState();
  };

  gaplessPlayer.onpause = () => {
    isPlaying = false;
    document.querySelector('.card')?.classList.remove('audio-playing');
    updatePlayPauseIcon();
    updateMediaSessionPlaybackState();
  };

  gaplessPlayer.onstop = () => {
    isPlaying = false;
    isLoading = false;
    document.querySelector('.card')?.classList.remove('audio-playing');
    updatePlayPauseIcon();
  };

  gaplessPlayer.onnext = () => {
    const newIndex = gaplessPlayer.getIndex();
    if (newIndex >= 0 && newIndex < tracksWithAudio.length) {
      const track = tracksWithAudio[newIndex];
      currentTrackIndex = findOriginalTrackIndex(track);
      updateTrackDisplay(track);
      updateWaveformImage(track.waveform_image_url);
      highlightPlayingTrack(currentTrackIndex);
      updateNavigationButtons();
      updateMediaSession(track);
    }
  };

  gaplessPlayer.onprev = () => {
    const newIndex = gaplessPlayer.getIndex();
    if (newIndex >= 0 && newIndex < tracksWithAudio.length) {
      const track = tracksWithAudio[newIndex];
      currentTrackIndex = findOriginalTrackIndex(track);
      updateTrackDisplay(track);
      updateWaveformImage(track.waveform_image_url);
      highlightPlayingTrack(currentTrackIndex);
      updateNavigationButtons();
      updateMediaSession(track);
    }
  };

  gaplessPlayer.onfinishedall = () => {
    isPlaying = false;
    isLoading = false;
    document.querySelector('.card')?.classList.remove('audio-playing');
    updatePlayPauseIcon();
  };

  gaplessPlayer.onerror = (trackPath, error) => {
    console.error('Audio error:', trackPath, error);
    showLoadingSpinner(false);
  };

  const playPauseBtn = document.getElementById('play-pause-btn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const headerPlayBtn = document.getElementById('header-play-btn');
  const scrubber = document.getElementById('scrubber');
  const playerCloseBtn = document.getElementById('player-close-btn');
  const scrubBackBtn = document.getElementById('scrub-back-btn');
  const scrubForwardBtn = document.getElementById('scrub-forward-btn');

  playPauseBtn?.addEventListener('click', togglePlayPause);
  prevBtn?.addEventListener('click', playPrevious);
  nextBtn?.addEventListener('click', playNext);
  scrubBackBtn?.addEventListener('click', () => scrub(-10));
  scrubForwardBtn?.addEventListener('click', () => scrub(10));
  headerPlayBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    showPlayer();
    playTrackAtIndex(findFirstPlayableIndex());
  });
  scrubber?.addEventListener('click', onScrubberClick);
  playerCloseBtn?.addEventListener('click', hidePlayer);

  document.querySelectorAll('.track:not(.no-audio)').forEach(el => {
    el.addEventListener('click', (e) => {
      if (e.target.closest('a')) return;
      const index = parseInt(el.dataset.index, 10);
      showPlayer();
      playTrackAtIndex(index);
    });
  });
}

function findOriginalTrackIndex(track) {
  return allTracks.findIndex(t => t.mp3_url === track.mp3_url);
}

function findFirstPlayableIndex() {
  return allTracks.findIndex(t => t.mp3_url);
}

function playTrackAtIndex(index) {
  if (index < 0 || index >= allTracks.length) return;
  const track = allTracks[index];
  if (!track.mp3_url) return;

  currentTrackIndex = index;

  const tracksWithAudio = getTracksWithAudio();
  const gaplessIndex = tracksWithAudio.findIndex(t => t.mp3_url === track.mp3_url);
  
  if (gaplessIndex >= 0) {
    gaplessPlayer.gotoTrack(gaplessIndex);
    gaplessPlayer.play();
  }

  updateTrackDisplay(track);
  updateWaveformImage(track.waveform_image_url);
  highlightPlayingTrack(index);
  updateNavigationButtons();
  updateMediaSession(track);
}

function updateTrackDisplay(track) {
  const titleEl = document.getElementById('player-track-title');
  if (titleEl) titleEl.textContent = track.title;
  
  const subtitleEl = document.getElementById('player-track-subtitle');
  if (subtitleEl && (track.subtitleHtml || track.subtitle)) {
    subtitleEl.innerHTML = track.subtitleHtml || escapeHtml(track.subtitle);
    subtitleEl.style.display = 'block';
  } else if (subtitleEl) {
    subtitleEl.style.display = 'none';
  }
  
  const playPauseBtn = document.getElementById('play-pause-btn');
  if (playPauseBtn) playPauseBtn.disabled = false;
}

function updateWaveformImage(waveformUrl) {
  const scrubber = document.getElementById('scrubber');
  
  if (!waveformUrl) {
    if (scrubber) {
      scrubber.style.setProperty('--waveform-url', 'none');
      scrubber.classList.remove('loaded');
    }
    return;
  }

  scrubber?.classList.remove('loaded');
  
  const img = new Image();
  img.onload = () => {
    if (scrubber) {
      scrubber.style.setProperty('--waveform-url', `url(${waveformUrl})`);
      scrubber.classList.add('loaded');
    }
  };
  img.src = waveformUrl;
}

function highlightPlayingTrack(index) {
  document.querySelectorAll('.track').forEach(el => el.classList.remove('active-item'));
  const trackEl = document.querySelector(`.track[data-index="${index}"]`);
  if (trackEl) {
    trackEl.classList.add('active-item');
    trackEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

function togglePlayPause() {
  if (!gaplessPlayer) return;
  
  if (currentTrackIndex === -1) {
    showPlayer();
    playTrackAtIndex(findFirstPlayableIndex());
    return;
  }

  gaplessPlayer.playpause();
}

function updatePlayPauseIcon() {
  const playIcon = document.getElementById('play-icon');
  const pauseIcon = document.getElementById('pause-icon');
  if (playIcon && pauseIcon) {
    if (isLoading) {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'none';
    } else {
      playIcon.style.display = isPlaying ? 'none' : 'block';
      pauseIcon.style.display = isPlaying ? 'block' : 'none';
    }
  }
}

function findNextPlayableIndex() {
  for (let i = currentTrackIndex + 1; i < allTracks.length; i++) {
    if (allTracks[i].mp3_url) return i;
  }
  return -1;
}

function findPrevPlayableIndex() {
  for (let i = currentTrackIndex - 1; i >= 0; i--) {
    if (allTracks[i].mp3_url) return i;
  }
  return -1;
}

function playNext() {
  if (!gaplessPlayer) return;
  gaplessPlayer.next();
}

function playPrevious() {
  if (!gaplessPlayer) return;
  
  const currentPosition = gaplessPlayer.getPosition();
  const thresholdMs = 3000;
  
  if (currentPosition > thresholdMs) {
    gaplessPlayer.setPosition(0);
  } else {
    const prevIndex = findPrevPlayableIndex();
    if (prevIndex !== -1) {
      playTrackAtIndex(prevIndex);
    } else {
      gaplessPlayer.setPosition(0);
    }
  }
}

function scrub(seconds) {
  if (!gaplessPlayer) return;
  
  const currentPosition = gaplessPlayer.getPosition();
  if (currentPosition < 0) return;
  
  const tracksWithAudio = getTracksWithAudio();
  const gaplessIndex = gaplessPlayer.getIndex();
  const track = tracksWithAudio[gaplessIndex];
  if (!track) return;

  const duration = track.duration_ms ? track.duration_ms / 1000 : 0;
  const currentTime = currentPosition / 1000;
  const newTime = currentTime + seconds;
  const clampedTime = Math.max(0, Math.min(newTime, duration));
  
  gaplessPlayer.setPosition(clampedTime * 1000);
}

function updateNavigationButtons() {
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const scrubBackBtn = document.getElementById('scrub-back-btn');
  const scrubForwardBtn = document.getElementById('scrub-forward-btn');
  
  if (prevBtn) prevBtn.disabled = currentTrackIndex === -1;
  if (nextBtn) nextBtn.disabled = findNextPlayableIndex() === -1;
  if (scrubBackBtn) scrubBackBtn.disabled = currentTrackIndex === -1;
  if (scrubForwardBtn) scrubForwardBtn.disabled = currentTrackIndex === -1;
}

function onScrubberClick(e) {
  if (!gaplessPlayer) return;
  
  const tracksWithAudio = getTracksWithAudio();
  const gaplessIndex = gaplessPlayer.getIndex();
  const track = tracksWithAudio[gaplessIndex];
  if (!track) return;

  const duration = track.duration_ms ? track.duration_ms / 1000 : 0;
  if (duration <= 0) return;
  
  const rect = e.currentTarget.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const percent = x / rect.width;
  gaplessPlayer.setPosition(percent * duration * 1000);
}

function showLoadingSpinner(show) {
  isLoading = show;
  
  const spinner = document.getElementById('loading-spinner');
  const playIcon = document.getElementById('play-icon');
  const pauseIcon = document.getElementById('pause-icon');
  
  if (spinner) spinner.style.display = show ? 'block' : 'none';
  
  if (show) {
    if (playIcon) playIcon.style.display = 'none';
    if (pauseIcon) pauseIcon.style.display = 'none';
  } else {
    updatePlayPauseIcon();
  }
}

function isIOSDevice() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

function updateMediaSession(track) {
  if (!('mediaSession' in navigator) || !track) return;

  let formattedDate, venue, coverArtUrl, album;

  if (showMetadata?.isPlaylist) {
    formattedDate = track.date ? formatDate(track.date) : '';
    venue = track.venue || '';
    coverArtUrl = track.cover_art_url || showMetadata.cover_art_url || '';
    album = showMetadata.name || 'Playlist';
  } else if (showMetadata) {
    formattedDate = showMetadata.date ? formatDate(showMetadata.date) : '';
    venue = showMetadata.venue || '';
    coverArtUrl = showMetadata.cover_art_url || '';
    album = `${formattedDate} - ${venue}`;
  } else {
    return;
  }

  navigator.mediaSession.metadata = new MediaMetadata({
    title: track.title,
    artist: `Phish - ${formattedDate}`,
    album: album,
    artwork: coverArtUrl ? [{
      src: coverArtUrl,
      sizes: '256x256',
      type: 'image/jpeg'
    }] : []
  });

  navigator.mediaSession.setActionHandler('play', togglePlayPause);
  navigator.mediaSession.setActionHandler('pause', togglePlayPause);
  navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
  navigator.mediaSession.setActionHandler('nexttrack', findNextPlayableIndex() !== -1 ? playNext : null);

  if (!isIOSDevice()) {
    navigator.mediaSession.setActionHandler('seekbackward', () => scrub(-10));
    navigator.mediaSession.setActionHandler('seekforward', () => scrub(10));
  }
}

function updateMediaSessionPlaybackState() {
  if ('mediaSession' in navigator) {
    navigator.mediaSession.playbackState = isPlaying ? 'playing' : 'paused';
  }
}

function initKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    if (['INPUT', 'TEXTAREA'].includes(document.activeElement?.tagName) || document.activeElement?.isContentEditable) return;
    if (!gaplessPlayer) return;

    if (e.key === ' ' && !e.shiftKey) {
      e.preventDefault();
      if (currentTrackIndex === -1) {
        showPlayer();
        playTrackAtIndex(findFirstPlayableIndex());
      } else {
        togglePlayPause();
      }
    } else if (e.key === 'ArrowLeft' && !e.shiftKey) {
      e.preventDefault();
      playPrevious();
    } else if (e.key === 'ArrowRight' && !e.shiftKey) {
      e.preventDefault();
      playNext();
    } else if (e.key === 'ArrowLeft' && e.shiftKey) {
      e.preventDefault();
      scrub(-10);
    } else if (e.key === 'ArrowRight' && e.shiftKey) {
      e.preventDefault();
      scrub(10);
    }
  });
}
