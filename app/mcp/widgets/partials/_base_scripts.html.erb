function formatDate(dateString) {
  if (!dateString) return "";
  const datePart = dateString.slice(0, 10);
  const [year, month, day] = datePart.split("-").map(Number);
  const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
  return `${monthNames[month - 1]} ${day}, ${year}`;
}

function formatDuration(milliseconds) {
  const totalMinutes = Math.floor(milliseconds / 60000);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  if (hours > 0) {
    return minutes > 0 ? `${hours}h ${minutes}m` : `${hours}h`;
  }
  return `${minutes}m`;
}

function formatTime(seconds) {
  if (!seconds || seconds < 0) return "0:00";
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function truncateText(str, maxLength) {
  if (!str || str.length <= maxLength) return escapeHtml(str);
  return escapeHtml(str.slice(0, maxLength).trim()) + 'â€¦';
}

function parseDuration(durationStr) {
  if (!durationStr) return 0;
  const parts = durationStr.split(':').map(Number);
  if (parts.length === 3) {
    return (parts[0] * 3600 + parts[1] * 60 + parts[2]) * 1000;
  } else if (parts.length === 2) {
    return (parts[0] * 60 + parts[1]) * 1000;
  }
  return 0;
}

const MAX_POLL_ATTEMPTS = 100;
const POLL_INTERVAL_MS = 100;

function getData() {
  if (window._widgetData) return window._widgetData;
  const oa = window.openai || {};
  return oa.toolOutput?.structuredContent 
      || oa.toolOutput 
      || oa.widget?.props 
      || oa.view?.params
      || null;
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function waitForData(isComplete) {
  for (let i = 0; i < MAX_POLL_ATTEMPTS; i++) {
    const data = getData();
    if (isComplete(data)) return data;
    await sleep(POLL_INTERVAL_MS);
  }
  return getData();
}

function setupBackgroundBlur(imageUrl, imgElementId = 'cover-img', blurElementId = 'bg-blur') {
  if (!imageUrl) return;
  
  const bgEl = document.getElementById(blurElementId);
  if (!bgEl) return;

  const applyBlur = () => {
    bgEl.style.backgroundImage = `url("${imageUrl}")`;
    const player = document.getElementById('audio-player');
    if (player) {
      player.style.setProperty('--player-bg-image', `url("${imageUrl}")`);
    }
  };

  const coverImg = document.getElementById(imgElementId);
  if (coverImg && !coverImg.complete) {
    coverImg.onload = applyBlur;
  } else {
    applyBlur();
  }
}

function initExpandButton() {
  const expandBtn = document.getElementById('expand-btn');
  const card = document.querySelector('.card');
  if (!expandBtn || !card) return;

  expandBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    card.classList.toggle('expanded');
    expandBtn.title = card.classList.contains('expanded') ? 'Collapse' : 'Expand';
  });
}

function showToast(message) {
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.textContent = message;
  toast.classList.add('visible');
  setTimeout(() => {
    toast.classList.remove('visible');
  }, 2000);
}

function showCopiedFeedback() {
  const shareBtn = document.getElementById('share-btn');
  if (shareBtn) {
    shareBtn.classList.add('copied');
    setTimeout(() => {
      shareBtn.classList.remove('copied');
    }, 1500);
  }
  showToast("URL copied to clipboard");
}

function fallbackCopyToClipboard(text, onSuccess) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  textArea.style.position = "fixed";
  textArea.style.left = "-9999px";
  textArea.style.top = "0";
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  try {
    document.execCommand("copy");
    if (onSuccess) onSuccess();
  } catch (err) {
    showToast("Failed to copy URL");
  }
  document.body.removeChild(textArea);
}

function copyToClipboard(url) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url)
      .then(() => showCopiedFeedback())
      .catch(() => fallbackCopyToClipboard(url, showCopiedFeedback));
  } else {
    fallbackCopyToClipboard(url, showCopiedFeedback);
  }
}

function initShareButton(getShareUrl) {
  const shareBtn = document.getElementById('share-btn');
  if (shareBtn && getShareUrl) {
    shareBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const url = getShareUrl();
      if (url) copyToClipboard(url);
    });
  }
}

function renderShareButton() {
  return `<button class="share-btn" id="share-btn" title="Share"><svg class="share-icon" viewBox="0 0 512 512" fill="currentColor"><path d="M307 34.8c-11.5 5.1-19 16.6-19 29.2v64H176C78.8 128 0 206.8 0 304C0 417.3 81.5 467.9 100.2 478.1c2.5 1.4 5.3 1.9 8.1 1.9c10.9 0 19.7-8.9 19.7-19.7c0-7.5-4.3-14.4-9.8-19.5C108.8 431.9 96 414.4 96 384c0-53 43-96 96-96h96v64c0 12.6 7.4 24.1 19 29.2s25 3 34.4-5.4l160-144c6.7-6.1 10.6-14.7 10.6-23.8s-3.8-17.7-10.6-23.8l-160-144c-9.4-8.5-22.9-10.6-34.4-5.4z"/></svg><svg class="check-icon" viewBox="0 0 512 512" fill="currentColor"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg></button>`;
}

function renderToast() {
  return `<div class="toast" id="toast"></div>`;
}

